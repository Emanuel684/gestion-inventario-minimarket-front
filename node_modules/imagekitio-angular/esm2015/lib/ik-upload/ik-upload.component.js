import { ElementRef, Component, Input, Output, EventEmitter } from '@angular/core';
import { ImagekitService } from '../imagekitio-angular.service';
import * as i0 from "@angular/core";
import * as i1 from "../imagekitio-angular.service";
import * as i2 from "@angular/common";
export class IkUploadComponent {
    constructor(el, imagekit) {
        this.el = el;
        this.imagekit = imagekit;
        this.onError = new EventEmitter();
        this.onSuccess = new EventEmitter();
        this.fileToUpload = null;
        this.handleAuthResponse = ({ signature, token, expire }, ik, params, options, progressCb) => {
            ik.upload(Object.assign(Object.assign({}, params), { signature, token, expire }), (err, result) => {
                this.handleUploadResponse(err, result, options, progressCb);
            });
        };
    }
    ngAfterViewInit() {
        this.buttonRef && this.buttonRef.addEventListener('click', () => { this.el.nativeElement.children[0].click(); });
    }
    abort() {
        if (this.xhr) {
            this.xhr.abort();
        }
    }
    handleFileInput(e) {
        // Using IK-upload
        const files = e.target.files;
        this.fileToUpload = files.item(0);
        const options = {
            file: this.fileToUpload,
            fileName: this.fileName || this.fileToUpload.name,
            useUniqueFileName: this.useUniqueFileName,
            tags: this.tags,
            folder: this.folder,
            customMetadata: this.customMetadata,
            isPrivateFile: this.isPrivateFile,
            overwriteFile: this.overwriteFile,
            overwriteAITags: this.overwriteAITags,
            overwriteTags: this.overwriteTags,
            overwriteCustomMetadata: this.overwriteCustomMetadata,
            customCoordinates: this.customCoordinates,
            responseFields: this.responseFields,
            extensions: this.extensions,
            webhookUrl: this.webhookUrl,
            onError: this.onError,
            onSuccess: this.onSuccess,
            transformation: this.transformation,
            checks: this.checks
        };
        // Custom validation
        if (!this.checkCustomFileValidation(options.file)) {
            return;
        }
        if (!this.checkAuthenticator(options)) {
            return;
        }
        this.startIkUpload(e, options);
    }
    checkCustomFileValidation(file) {
        if (this.validateFile && typeof this.validateFile === 'function') {
            return this.validateFile(file);
        }
        return true;
    }
    checkAuthenticator(options) {
        if (!this.authenticator || typeof this.authenticator !== "function" || this.authenticator.length !== 0 || !(this.authenticator() instanceof Promise)) {
            return this.throwError("The authenticator function is not provided or is not a function.", options);
        }
        return true;
    }
    throwError(message, options) {
        if (options && options.onError instanceof EventEmitter) {
            options.onError.emit({
                message: message || "Something went wrong.",
            });
        }
        return false;
    }
    startIkUpload(e, options) {
        // Custom upload-start tracker
        if (this.onUploadStart && typeof this.onUploadStart === 'function') {
            this.onUploadStart(e);
        }
        // Custom upload-progress tracker
        options.xhr = new XMLHttpRequest();
        this.xhr = options.xhr;
        const params = this.getUploadParams(options);
        const progressCb = this.createUploadProgressMonitor(options.xhr);
        const ik = this.getIkInstance();
        const authPromise = this.authenticator();
        authPromise.then((obj) => this.handleAuthResponse(obj, ik, params, options, progressCb)).catch((data) => {
            var error;
            if (data instanceof Array) {
                error = data[0];
            }
            else {
                error = data;
            }
            this.throwError(String(error), options);
        });
    }
    getIkInstance() {
        if (this.publicKey === undefined ||
            this.urlEndpoint === undefined) {
            return this.imagekit.ikInstance;
        }
        return new ImagekitService({
            urlEndpoint: this.urlEndpoint,
            publicKey: this.publicKey,
        })._ikInstance;
    }
    handleUploadResponse(err, result, options, progressCb) {
        if (err) {
            this.throwError(err, options);
        }
        else {
            if (options.onSuccess instanceof EventEmitter) {
                options.onSuccess.emit(result);
            }
            if (options.xhr)
                options.xhr.upload.removeEventListener('progress', progressCb);
        }
    }
    createUploadProgressMonitor(xhr) {
        const progressCb = (e) => {
            if (this.onUploadProgress && typeof this.onUploadProgress === 'function') {
                // Custom upload-progress tracker
                this.onUploadProgress(e);
            }
        };
        if (xhr)
            xhr.upload.addEventListener('progress', progressCb);
        return progressCb;
    }
    getUploadParams(options) {
        const params = {
            file: options.file,
            fileName: options.fileName
        };
        if (options.useUniqueFileName !== undefined) {
            Object.assign(params, { useUniqueFileName: options.useUniqueFileName });
        }
        if (options.folder !== undefined) {
            Object.assign(params, { folder: options.folder });
        }
        if (options.customMetadata !== undefined) {
            Object.assign(params, { customMetadata: options.customMetadata });
        }
        if (options.webhookUrl !== undefined) {
            Object.assign(params, { webhookUrl: options.webhookUrl });
        }
        if (options.isPrivateFile !== undefined) {
            Object.assign(params, { isPrivateFile: options.isPrivateFile });
        }
        if (options.overwriteFile !== undefined) {
            Object.assign(params, { overwriteFile: options.overwriteFile });
        }
        if (options.overwriteAITags !== undefined) {
            Object.assign(params, { overwriteAITags: options.overwriteAITags });
        }
        if (options.overwriteTags !== undefined) {
            Object.assign(params, { overwriteTags: options.overwriteTags });
        }
        if (options.overwriteCustomMetadata !== undefined) {
            Object.assign(params, { overwriteCustomMetadata: options.overwriteCustomMetadata });
        }
        if (options.tags !== undefined) {
            Object.assign(params, { tags: options.tags });
        }
        if (options.customCoordinates !== undefined) {
            Object.assign(params, { customCoordinates: options.customCoordinates });
        }
        if (options.responseFields !== undefined) {
            Object.assign(params, { responseFields: options.responseFields });
        }
        if (options.extensions !== undefined) {
            Object.assign(params, { extensions: options.extensions });
        }
        if (options.xhr !== undefined) {
            Object.assign(params, { xhr: options.xhr });
        }
        if (options.transformation !== undefined) {
            Object.assign(params, { transformation: options.transformation });
        }
        if (options.checks !== undefined) {
            Object.assign(params, { checks: options.checks });
        }
        return params;
    }
}
IkUploadComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: IkUploadComponent, deps: [{ token: i0.ElementRef }, { token: i1.ImagekitService }], target: i0.ɵɵFactoryTarget.Component });
IkUploadComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.17", type: IkUploadComponent, selector: "ik-upload", inputs: { fileName: "fileName", useUniqueFileName: "useUniqueFileName", tags: "tags", folder: "folder", publicKey: "publicKey", urlEndpoint: "urlEndpoint", authenticator: "authenticator", isPrivateFile: "isPrivateFile", overwriteFile: "overwriteFile", overwriteAITags: "overwriteAITags", overwriteTags: "overwriteTags", overwriteCustomMetadata: "overwriteCustomMetadata", customCoordinates: "customCoordinates", webhookUrl: "webhookUrl", responseFields: "responseFields", extensions: "extensions", customMetadata: "customMetadata", buttonRef: "buttonRef", validateFile: "validateFile", onUploadStart: "onUploadStart", onUploadProgress: "onUploadProgress", transformation: "transformation", checks: "checks" }, outputs: { onError: "onError", onSuccess: "onSuccess" }, providers: [ImagekitService], ngImport: i0, template: `
  <input *ngIf="buttonRef; else elseBlock" type="file" (change)="handleFileInput($event)" style="display:none"/>
  <ng-template #elseBlock>
    <input type="file" (change)="handleFileInput($event)" />
  </ng-template>
  `, isInline: true, directives: [{ type: i2.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: IkUploadComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'ik-upload',
                    template: `
  <input *ngIf="buttonRef; else elseBlock" type="file" (change)="handleFileInput($event)" style="display:none"/>
  <ng-template #elseBlock>
    <input type="file" (change)="handleFileInput($event)" />
  </ng-template>
  `,
                    providers: [ImagekitService]
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i1.ImagekitService }]; }, propDecorators: { fileName: [{
                type: Input,
                args: ['fileName']
            }], useUniqueFileName: [{
                type: Input,
                args: ['useUniqueFileName']
            }], tags: [{
                type: Input,
                args: ['tags']
            }], folder: [{
                type: Input,
                args: ['folder']
            }], publicKey: [{
                type: Input,
                args: ['publicKey']
            }], urlEndpoint: [{
                type: Input,
                args: ['urlEndpoint']
            }], authenticator: [{
                type: Input,
                args: ["authenticator"]
            }], isPrivateFile: [{
                type: Input,
                args: ['isPrivateFile']
            }], overwriteFile: [{
                type: Input,
                args: ['overwriteFile']
            }], overwriteAITags: [{
                type: Input,
                args: ['overwriteAITags']
            }], overwriteTags: [{
                type: Input,
                args: ['overwriteTags']
            }], overwriteCustomMetadata: [{
                type: Input,
                args: ['overwriteCustomMetadata']
            }], customCoordinates: [{
                type: Input,
                args: ['customCoordinates']
            }], webhookUrl: [{
                type: Input,
                args: ['webhookUrl']
            }], responseFields: [{
                type: Input,
                args: ['responseFields']
            }], extensions: [{
                type: Input,
                args: ['extensions']
            }], customMetadata: [{
                type: Input,
                args: ['customMetadata']
            }], buttonRef: [{
                type: Input,
                args: ['buttonRef']
            }], onError: [{
                type: Output
            }], onSuccess: [{
                type: Output
            }], validateFile: [{
                type: Input,
                args: ['validateFile']
            }], onUploadStart: [{
                type: Input,
                args: ['onUploadStart']
            }], onUploadProgress: [{
                type: Input,
                args: ['onUploadProgress']
            }], transformation: [{
                type: Input,
                args: ['transformation']
            }], checks: [{
                type: Input,
                args: ['checks']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWstdXBsb2FkLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2ltYWdla2l0aW8tYW5ndWxhci9zcmMvbGliL2lrLXVwbG9hZC9pay11cGxvYWQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBaUIsVUFBVSxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNsRyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sK0JBQStCLENBQUM7Ozs7QUFhaEUsTUFBTSxPQUFPLGlCQUFpQjtJQTZCNUIsWUFBb0IsRUFBYyxFQUFVLFFBQXlCO1FBQWpELE9BQUUsR0FBRixFQUFFLENBQVk7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFpQjtRQVYzRCxZQUFPLEdBQXNCLElBQUksWUFBWSxFQUFFLENBQUM7UUFDaEQsY0FBUyxHQUFzQixJQUFJLFlBQVksRUFBRSxDQUFDO1FBTTVELGlCQUFZLEdBQVMsSUFBSSxDQUFDO1FBNkUxQix1QkFBa0IsR0FBRyxDQUFDLEVBQUMsU0FBUyxFQUFDLEtBQUssRUFBQyxNQUFNLEVBQUMsRUFBQyxFQUFFLEVBQUMsTUFBTSxFQUFDLE9BQU8sRUFBQyxVQUFVLEVBQUUsRUFBRTtZQUM3RSxFQUFFLENBQUMsTUFBTSxpQ0FBTSxNQUFNLEtBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLEtBQUksQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLEVBQUU7Z0JBQ2pFLElBQUksQ0FBQyxvQkFBb0IsQ0FDdkIsR0FBRyxFQUNILE1BQU0sRUFDTixPQUFPLEVBQ1AsVUFBVSxDQUNYLENBQUM7WUFDSixDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQTtJQWxGRCxDQUFDO0lBRUQsZUFBZTtRQUNiLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxnQkFB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QUFhO3NCQUFwQyxLQUFLO3VCQUFDLGVBQWU7Z0JBQ0UsYUFBYTtzQkFBcEMsS0FBSzt1QkFBQyxlQUFlO2dCQUNFLGFBQWE7c0JBQXBDLEtBQUs7dUJBQUMsZUFBZTtnQkFDSSxlQUFlO3NCQUF4QyxLQUFLO3VCQUFDLGlCQUFpQjtnQkFDQSxhQUFhO3NCQUFwQyxLQUFLO3VCQUFDLGVBQWU7Z0JBQ1ksdUJBQXVCO3NCQUF4RCxLQUFLO3VCQUFDLHlCQUF5QjtnQkFDSixpQkFBaUI7c0JBQTVDLEtBQUs7dUJBQUMsbUJBQW1CO2dCQUNMLFVBQVU7c0JBQTlCLEtBQUs7dUJBQUMsWUFBWTtnQkFDTSxjQUFjO3NCQUF0QyxLQUFLO3VCQUFDLGdCQUFnQjtnQkFDRixVQUFVO3NCQUE5QixLQUFLO3VCQUFDLFlBQVk7Z0JBQ00sY0FBYztzQkFBdEMsS0FBSzt1QkFBQyxnQkFBZ0I7Z0JBQ0gsU0FBUztzQkFBNUIsS0FBSzt1QkFBQyxXQUFXO2dCQUNSLE9BQU87c0JBQWhCLE1BQU07Z0JBQ0csU0FBUztzQkFBbEIsTUFBTTtnQkFDZ0IsWUFBWTtzQkFBbEMsS0FBSzt1QkFBQyxjQUFjO2dCQUNHLGFBQWE7c0JBQXBDLEtBQUs7dUJBQUMsZUFBZTtnQkFDSyxnQkFBZ0I7c0JBQTFDLEtBQUs7dUJBQUMsa0JBQWtCO2dCQUNBLGNBQWM7c0JBQXRDLEtBQUs7dUJBQUMsZ0JBQWdCO2dCQUNOLE1BQU07c0JBQXRCLEtBQUs7dUJBQUMsUUFBUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFmdGVyVmlld0luaXQsIEVsZW1lbnRSZWYsIENvbXBvbmVudCwgSW5wdXQsIE91dHB1dCwgRXZlbnRFbWl0dGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJbWFnZWtpdFNlcnZpY2UgfSBmcm9tICcuLi9pbWFnZWtpdGlvLWFuZ3VsYXIuc2VydmljZSc7XG5pbXBvcnQgeyBJa1VwbG9hZENvbXBvbmVudE9wdGlvbnMsIERpY3QsIEhUTUxJbnB1dEV2ZW50IH0gZnJvbSAnLi4vdXRpbGl0eS9pay10eXBlLWRlZi1jb2xsZWN0aW9uJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnaWstdXBsb2FkJyxcbiAgdGVtcGxhdGU6IGBcbiAgPGlucHV0ICpuZ0lmPVwiYnV0dG9uUmVmOyBlbHNlIGVsc2VCbG9ja1wiIHR5cGU9XCJmaWxlXCIgKGNoYW5nZSk9XCJoYW5kbGVGaWxlSW5wdXQoJGV2ZW50KVwiIHN0eWxlPVwiZGlzcGxheTpub25lXCIvPlxuICA8bmctdGVtcGxhdGUgI2Vsc2VCbG9jaz5cbiAgICA8aW5wdXQgdHlwZT1cImZpbGVcIiAoY2hhbmdlKT1cImhhbmRsZUZpbGVJbnB1dCgkZXZlbnQpXCIgLz5cbiAgPC9uZy10ZW1wbGF0ZT5cbiAgYCxcbiAgcHJvdmlkZXJzOiBbSW1hZ2VraXRTZXJ2aWNlXVxufSlcbmV4cG9ydCBjbGFzcyBJa1VwbG9hZENvbXBvbmVudCBpbXBsZW1lbnRzIEFmdGVyVmlld0luaXQge1xuICBASW5wdXQoJ2ZpbGVOYW1lJykgZmlsZU5hbWU6IHN0cmluZzsgLy9vcHRpb25hbFxuICBASW5wdXQoJ3VzZVVuaXF1ZUZpbGVOYW1lJykgdXNlVW5pcXVlRmlsZU5hbWU6IGJvb2xlYW47IC8vb3B0aW9uYWxcbiAgQElucHV0KCd0YWdzJykgdGFnczogQXJyYXk8c3RyaW5nPjsgLy9vcHRpb25hbFxuICBASW5wdXQoJ2ZvbGRlcicpIGZvbGRlcjogc3RyaW5nOyAvL29wdGlvbmFsXG4gIEBJbnB1dCgncHVibGljS2V5JykgcHVibGljS2V5OiBzdHJpbmc7IC8vb3B0aW9uYWxcbiAgQElucHV0KCd1cmxFbmRwb2ludCcpIHVybEVuZHBvaW50OiBzdHJpbmc7IC8vb3B0aW9uYWxcbiAgQElucHV0KFwiYXV0aGVudGljYXRvclwiKSBhdXRoZW50aWNhdG9yOiAoKSA9PiBQcm9taXNlPGFueT47XG4gIEBJbnB1dCgnaXNQcml2YXRlRmlsZScpIGlzUHJpdmF0ZUZpbGU6IGJvb2xlYW47IC8vb3B0aW9uYWxcbiAgQElucHV0KCdvdmVyd3JpdGVGaWxlJykgb3ZlcndyaXRlRmlsZTogYm9vbGVhbjsgLy9vcHRpb25hbFxuICBASW5wdXQoJ292ZXJ3cml0ZUFJVGFncycpIG92ZXJ3cml0ZUFJVGFnczogYm9vbGVhbjsgLy9vcHRpb25hbFxuICBASW5wdXQoJ292ZXJ3cml0ZVRhZ3MnKSBvdmVyd3JpdGVUYWdzOiBib29sZWFuOyAvL29wdGlvbmFsXG4gIEBJbnB1dCgnb3ZlcndyaXRlQ3VzdG9tTWV0YWRhdGEnKSBvdmVyd3JpdGVDdXN0b21NZXRhZGF0YTogYm9vbGVhbjsgLy9vcHRpb25hbFxuICBASW5wdXQoJ2N1c3RvbUNvb3JkaW5hdGVzJykgY3VzdG9tQ29vcmRpbmF0ZXM6IHN0cmluZzsgLy9vcHRpb25hbFxuICBASW5wdXQoJ3dlYmhvb2tVcmwnKSB3ZWJob29rVXJsOiBzdHJpbmc7IC8vb3B0aW9uYWxcbiAgQElucHV0KCdyZXNwb25zZUZpZWxkcycpIHJlc3BvbnNlRmllbGRzOiBBcnJheTxzdHJpbmc+OyAvL29wdGlvbmFsXG4gIEBJbnB1dCgnZXh0ZW5zaW9ucycpIGV4dGVuc2lvbnM6IEFycmF5PE9iamVjdD47IC8vb3B0aW9uYWxcbiAgQElucHV0KCdjdXN0b21NZXRhZGF0YScpIGN1c3RvbU1ldGFkYXRhOiBPYmplY3Q7IC8vb3B0aW9uYWxcbiAgQElucHV0KCdidXR0b25SZWYnKSBidXR0b25SZWY6IEhUTUxCdXR0b25FbGVtZW50OyAvL29wdGlvbmFsXG4gIEBPdXRwdXQoKSBvbkVycm9yOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQE91dHB1dCgpIG9uU3VjY2VzczogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBJbnB1dCgndmFsaWRhdGVGaWxlJykgdmFsaWRhdGVGaWxlOiAoZmlsZTogRmlsZSkgPT4gYm9vbGVhbjtcbiAgQElucHV0KCdvblVwbG9hZFN0YXJ0Jykgb25VcGxvYWRTdGFydDogKGU6IEhUTUxJbnB1dEV2ZW50KSA9PiB2b2lkO1xuICBASW5wdXQoJ29uVXBsb2FkUHJvZ3Jlc3MnKSBvblVwbG9hZFByb2dyZXNzOiAoZTogUHJvZ3Jlc3NFdmVudCkgPT4gdm9pZDtcbiAgQElucHV0KCd0cmFuc2Zvcm1hdGlvbicpIHRyYW5zZm9ybWF0aW9uOiBPYmplY3Q7IC8vb3B0aW9uYWxcbiAgQElucHV0KCdjaGVja3MnKSBjaGVja3M6IHN0cmluZzsgLy9vcHRpb25hbFxuICBmaWxlVG9VcGxvYWQ6IEZpbGUgPSBudWxsO1xuICB4aHI6IFhNTEh0dHBSZXF1ZXN0O1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZWw6IEVsZW1lbnRSZWYsIHByaXZhdGUgaW1hZ2VraXQ6IEltYWdla2l0U2VydmljZSkgeyBcbiAgfVxuICBcbiAgbmdBZnRlclZpZXdJbml0KCk6dm9pZCB7XG4gICAgdGhpcy5idXR0b25SZWYgJiYgdGhpcy5idXR0b25SZWYuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+e3RoaXMuZWwubmF0aXZlRWxlbWVudC5jaGlsZHJlblswXS5jbGljaygpfSk7XG4gIH1cblxuICBhYm9ydCgpIHtcbiAgICBpZiAodGhpcy54aHIpIHtcbiAgICAgIHRoaXMueGhyLmFib3J0KCk7XG4gICAgfVxuICB9XG5cbiAgaGFuZGxlRmlsZUlucHV0KGU6IEhUTUxJbnB1dEV2ZW50fCBhbnkpOiB2b2lkIHtcbiAgICAvLyBVc2luZyBJSy11cGxvYWRcbiAgICBjb25zdCBmaWxlcyA9IGUudGFyZ2V0LmZpbGVzO1xuICAgIHRoaXMuZmlsZVRvVXBsb2FkID0gZmlsZXMuaXRlbSgwKTtcbiAgICBjb25zdCBvcHRpb25zOiBJa1VwbG9hZENvbXBvbmVudE9wdGlvbnMgPSB7XG4gICAgICBmaWxlOiB0aGlzLmZpbGVUb1VwbG9hZCxcbiAgICAgIGZpbGVOYW1lOiB0aGlzLmZpbGVOYW1lIHx8IHRoaXMuZmlsZVRvVXBsb2FkLm5hbWUsXG4gICAgICB1c2VVbmlxdWVGaWxlTmFtZTogdGhpcy51c2VVbmlxdWVGaWxlTmFtZSxcbiAgICAgIHRhZ3M6IHRoaXMudGFncyxcbiAgICAgIGZvbGRlcjogdGhpcy5mb2xkZXIsXG4gICAgICBjdXN0b21NZXRhZGF0YTogdGhpcy5jdXN0b21NZXRhZGF0YSxcbiAgICAgIGlzUHJpdmF0ZUZpbGU6IHRoaXMuaXNQcml2YXRlRmlsZSxcbiAgICAgIG92ZXJ3cml0ZUZpbGU6IHRoaXMub3ZlcndyaXRlRmlsZSxcbiAgICAgIG92ZXJ3cml0ZUFJVGFnczogdGhpcy5vdmVyd3JpdGVBSVRhZ3MsXG4gICAgICBvdmVyd3JpdGVUYWdzOiB0aGlzLm92ZXJ3cml0ZVRhZ3MsXG4gICAgICBvdmVyd3JpdGVDdXN0b21NZXRhZGF0YTogdGhpcy5vdmVyd3JpdGVDdXN0b21NZXRhZGF0YSxcbiAgICAgIGN1c3RvbUNvb3JkaW5hdGVzOiB0aGlzLmN1c3RvbUNvb3JkaW5hdGVzLFxuICAgICAgcmVzcG9uc2VGaWVsZHM6IHRoaXMucmVzcG9uc2VGaWVsZHMsXG4gICAgICBleHRlbnNpb25zOiB0aGlzLmV4dGVuc2lvbnMsXG4gICAgICB3ZWJob29rVXJsOiB0aGlzLndlYmhvb2tVcmwsXG4gICAgICBvbkVycm9yOiB0aGlzLm9uRXJyb3IsXG4gICAgICBvblN1Y2Nlc3M6IHRoaXMub25TdWNjZXNzLFxuICAgICAgdHJhbnNmb3JtYXRpb246IHRoaXMudHJhbnNmb3JtYXRpb24sXG4gICAgICBjaGVja3M6IHRoaXMuY2hlY2tzXG4gICAgfVxuXG4gICAgLy8gQ3VzdG9tIHZhbGlkYXRpb25cbiAgICBpZiAoIXRoaXMuY2hlY2tDdXN0b21GaWxlVmFsaWRhdGlvbihvcHRpb25zLmZpbGUpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLmNoZWNrQXV0aGVudGljYXRvcihvcHRpb25zKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBcbiAgICB0aGlzLnN0YXJ0SWtVcGxvYWQoZSwgb3B0aW9ucyk7XG4gIH1cbiAgXG4gIGNoZWNrQ3VzdG9tRmlsZVZhbGlkYXRpb24oZmlsZTogRmlsZSk6IGJvb2xlYW4ge1xuICAgIGlmICh0aGlzLnZhbGlkYXRlRmlsZSAmJiB0eXBlb2YgdGhpcy52YWxpZGF0ZUZpbGUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgcmV0dXJuIHRoaXMudmFsaWRhdGVGaWxlKGZpbGUpO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGNoZWNrQXV0aGVudGljYXRvcihvcHRpb25zOiBJa1VwbG9hZENvbXBvbmVudE9wdGlvbnMpOiBib29sZWFuIHtcbiAgICBpZiAoIXRoaXMuYXV0aGVudGljYXRvciB8fCB0eXBlb2YgdGhpcy5hdXRoZW50aWNhdG9yICE9PSBcImZ1bmN0aW9uXCIgfHwgdGhpcy5hdXRoZW50aWNhdG9yLmxlbmd0aCAhPT0gMCB8fCAhKHRoaXMuYXV0aGVudGljYXRvcigpIGluc3RhbmNlb2YgUHJvbWlzZSkpIHtcbiAgICAgIHJldHVybiB0aGlzLnRocm93RXJyb3IoXCJUaGUgYXV0aGVudGljYXRvciBmdW5jdGlvbiBpcyBub3QgcHJvdmlkZWQgb3IgaXMgbm90IGEgZnVuY3Rpb24uXCIsIG9wdGlvbnMpXG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgdGhyb3dFcnJvcihtZXNzYWdlOiBzdHJpbmcsIG9wdGlvbnM6IElrVXBsb2FkQ29tcG9uZW50T3B0aW9ucyk6IGJvb2xlYW4ge1xuICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMub25FcnJvciBpbnN0YW5jZW9mIEV2ZW50RW1pdHRlcikge1xuICAgICAgb3B0aW9ucy5vbkVycm9yLmVtaXQoe1xuICAgICAgICBtZXNzYWdlOiBtZXNzYWdlIHx8IFwiU29tZXRoaW5nIHdlbnQgd3JvbmcuXCIsXG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgaGFuZGxlQXV0aFJlc3BvbnNlID0gKHtzaWduYXR1cmUsdG9rZW4sZXhwaXJlfSxpayxwYXJhbXMsb3B0aW9ucyxwcm9ncmVzc0NiKSA9PiB7XG4gICAgaWsudXBsb2FkKHsgLi4ucGFyYW1zLCBzaWduYXR1cmUsIHRva2VuLCBleHBpcmUgfSwgKGVyciwgcmVzdWx0KSA9PiB7XG4gICAgICB0aGlzLmhhbmRsZVVwbG9hZFJlc3BvbnNlKFxuICAgICAgICBlcnIsXG4gICAgICAgIHJlc3VsdCxcbiAgICAgICAgb3B0aW9ucyxcbiAgICAgICAgcHJvZ3Jlc3NDYlxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIHN0YXJ0SWtVcGxvYWQoZTogSFRNTElucHV0RXZlbnQsIG9wdGlvbnM6IElrVXBsb2FkQ29tcG9uZW50T3B0aW9ucyk6IHZvaWQge1xuICAgIC8vIEN1c3RvbSB1cGxvYWQtc3RhcnQgdHJhY2tlclxuICAgIGlmICh0aGlzLm9uVXBsb2FkU3RhcnQgJiYgdHlwZW9mIHRoaXMub25VcGxvYWRTdGFydCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhpcy5vblVwbG9hZFN0YXJ0KGUpO1xuICAgIH1cblxuICAgIC8vIEN1c3RvbSB1cGxvYWQtcHJvZ3Jlc3MgdHJhY2tlclxuICAgIG9wdGlvbnMueGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gICAgdGhpcy54aHIgPSBvcHRpb25zLnhocjtcbiAgICBjb25zdCBwYXJhbXMgPSB0aGlzLmdldFVwbG9hZFBhcmFtcyhvcHRpb25zKTtcbiAgICBjb25zdCBwcm9ncmVzc0NiID0gdGhpcy5jcmVhdGVVcGxvYWRQcm9ncmVzc01vbml0b3Iob3B0aW9ucy54aHIpO1xuICAgIGNvbnN0IGlrID0gdGhpcy5nZXRJa0luc3RhbmNlKCk7XG4gICAgY29uc3QgYXV0aFByb21pc2UgPSB0aGlzLmF1dGhlbnRpY2F0b3IoKTtcbiAgICAgIFxuICAgIGF1dGhQcm9taXNlLnRoZW4oKG9iaik9PnRoaXMuaGFuZGxlQXV0aFJlc3BvbnNlKG9iaixpayxwYXJhbXMsb3B0aW9ucyxwcm9ncmVzc0NiKSkuY2F0Y2goKGRhdGEpID0+IHtcbiAgICAgIHZhciBlcnJvcjtcbiAgICAgIGlmIChkYXRhIGluc3RhbmNlb2YgQXJyYXkpIHtcbiAgICAgICAgZXJyb3IgPSBkYXRhWzBdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZXJyb3IgPSBkYXRhO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnRocm93RXJyb3IoU3RyaW5nKGVycm9yKSwgb3B0aW9ucyk7XG4gICAgfSk7XG4gIH1cblxuICBnZXRJa0luc3RhbmNlKCk6IGFueSB7XG4gICAgaWYodGhpcy5wdWJsaWNLZXkgPT09IHVuZGVmaW5lZCB8fCBcbiAgICAgIHRoaXMudXJsRW5kcG9pbnQgPT09IHVuZGVmaW5lZCApe1xuICAgICAgICByZXR1cm4gdGhpcy5pbWFnZWtpdC5pa0luc3RhbmNlO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IEltYWdla2l0U2VydmljZSh7XG4gICAgICB1cmxFbmRwb2ludDogdGhpcy51cmxFbmRwb2ludCxcbiAgICAgIHB1YmxpY0tleTogdGhpcy5wdWJsaWNLZXksXG4gICAgfSkuX2lrSW5zdGFuY2VcbiAgfVxuXG4gIGhhbmRsZVVwbG9hZFJlc3BvbnNlKGVyciwgcmVzdWx0LCBvcHRpb25zLCBwcm9ncmVzc0NiKTogdm9pZCB7XG4gICAgaWYgKGVycikge1xuICAgICAgdGhpcy50aHJvd0Vycm9yKGVyciwgb3B0aW9ucyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmKG9wdGlvbnMub25TdWNjZXNzIGluc3RhbmNlb2YgRXZlbnRFbWl0dGVyKSB7XG4gICAgICAgIG9wdGlvbnMub25TdWNjZXNzLmVtaXQocmVzdWx0KTtcbiAgICAgIH1cbiAgICAgIGlmKG9wdGlvbnMueGhyKVxuICAgICAgb3B0aW9ucy54aHIudXBsb2FkLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Byb2dyZXNzJywgcHJvZ3Jlc3NDYik7XG4gICAgfVxuICB9XG5cbiAgY3JlYXRlVXBsb2FkUHJvZ3Jlc3NNb25pdG9yKHhocjogWE1MSHR0cFJlcXVlc3QpOiBhbnkge1xuICAgIGNvbnN0IHByb2dyZXNzQ2IgPSAoZTogUHJvZ3Jlc3NFdmVudCkgPT4ge1xuICAgICAgaWYgKHRoaXMub25VcGxvYWRQcm9ncmVzcyAmJiB0eXBlb2YgdGhpcy5vblVwbG9hZFByb2dyZXNzID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIC8vIEN1c3RvbSB1cGxvYWQtcHJvZ3Jlc3MgdHJhY2tlclxuICAgICAgICB0aGlzLm9uVXBsb2FkUHJvZ3Jlc3MoZSk7XG4gICAgICB9XG4gICAgfTtcbiAgICBpZih4aHIpXG4gICAgeGhyLnVwbG9hZC5hZGRFdmVudExpc3RlbmVyKCdwcm9ncmVzcycsIHByb2dyZXNzQ2IpO1xuICAgIHJldHVybiBwcm9ncmVzc0NiO1xuICB9XG5cbiAgZ2V0VXBsb2FkUGFyYW1zKG9wdGlvbnM6IElrVXBsb2FkQ29tcG9uZW50T3B0aW9ucyk6IERpY3Qge1xuICAgIGNvbnN0IHBhcmFtczogRGljdCA9IHtcbiAgICAgIGZpbGU6IG9wdGlvbnMuZmlsZSxcbiAgICAgIGZpbGVOYW1lOiBvcHRpb25zLmZpbGVOYW1lXG4gICAgfTtcblxuICAgIGlmIChvcHRpb25zLnVzZVVuaXF1ZUZpbGVOYW1lICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIE9iamVjdC5hc3NpZ24ocGFyYW1zLCB7IHVzZVVuaXF1ZUZpbGVOYW1lOiBvcHRpb25zLnVzZVVuaXF1ZUZpbGVOYW1lIH0pO1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zLmZvbGRlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBPYmplY3QuYXNzaWduKHBhcmFtcywgeyBmb2xkZXI6IG9wdGlvbnMuZm9sZGVyIH0pO1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zLmN1c3RvbU1ldGFkYXRhICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIE9iamVjdC5hc3NpZ24ocGFyYW1zLCB7IGN1c3RvbU1ldGFkYXRhOiBvcHRpb25zLmN1c3RvbU1ldGFkYXRhIH0pO1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zLndlYmhvb2tVcmwgIT09IHVuZGVmaW5lZCkge1xuICAgICAgT2JqZWN0LmFzc2lnbihwYXJhbXMsIHsgd2ViaG9va1VybDogb3B0aW9ucy53ZWJob29rVXJsIH0pO1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zLmlzUHJpdmF0ZUZpbGUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgT2JqZWN0LmFzc2lnbihwYXJhbXMsIHsgaXNQcml2YXRlRmlsZTogb3B0aW9ucy5pc1ByaXZhdGVGaWxlIH0pO1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zLm92ZXJ3cml0ZUZpbGUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgT2JqZWN0LmFzc2lnbihwYXJhbXMsIHsgb3ZlcndyaXRlRmlsZTogb3B0aW9ucy5vdmVyd3JpdGVGaWxlIH0pO1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zLm92ZXJ3cml0ZUFJVGFncyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBPYmplY3QuYXNzaWduKHBhcmFtcywgeyBvdmVyd3JpdGVBSVRhZ3M6IG9wdGlvbnMub3ZlcndyaXRlQUlUYWdzIH0pO1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zLm92ZXJ3cml0ZVRhZ3MgIT09IHVuZGVmaW5lZCkge1xuICAgICAgT2JqZWN0LmFzc2lnbihwYXJhbXMsIHsgb3ZlcndyaXRlVGFnczogb3B0aW9ucy5vdmVyd3JpdGVUYWdzIH0pO1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zLm92ZXJ3cml0ZUN1c3RvbU1ldGFkYXRhICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIE9iamVjdC5hc3NpZ24ocGFyYW1zLCB7IG92ZXJ3cml0ZUN1c3RvbU1ldGFkYXRhOiBvcHRpb25zLm92ZXJ3cml0ZUN1c3RvbU1ldGFkYXRhIH0pO1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zLnRhZ3MgIT09IHVuZGVmaW5lZCkge1xuICAgICAgT2JqZWN0LmFzc2lnbihwYXJhbXMsIHsgdGFnczogb3B0aW9ucy50YWdzIH0pO1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zLmN1c3RvbUNvb3JkaW5hdGVzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIE9iamVjdC5hc3NpZ24ocGFyYW1zLCB7IGN1c3RvbUNvb3JkaW5hdGVzOiBvcHRpb25zLmN1c3RvbUNvb3JkaW5hdGVzIH0pO1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zLnJlc3BvbnNlRmllbGRzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIE9iamVjdC5hc3NpZ24ocGFyYW1zLCB7IHJlc3BvbnNlRmllbGRzOiBvcHRpb25zLnJlc3BvbnNlRmllbGRzIH0pO1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zLmV4dGVuc2lvbnMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgT2JqZWN0LmFzc2lnbihwYXJhbXMsIHsgZXh0ZW5zaW9uczogb3B0aW9ucy5leHRlbnNpb25zIH0pO1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zLnhociAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBPYmplY3QuYXNzaWduKHBhcmFtcywgeyB4aHI6IG9wdGlvbnMueGhyIH0pO1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zLnRyYW5zZm9ybWF0aW9uICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIE9iamVjdC5hc3NpZ24ocGFyYW1zLCB7IHRyYW5zZm9ybWF0aW9uOiBvcHRpb25zLnRyYW5zZm9ybWF0aW9uIH0pO1xuICAgIH1cblxuICAgIGlmIChvcHRpb25zLmNoZWNrcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBPYmplY3QuYXNzaWduKHBhcmFtcywgeyBjaGVja3M6IG9wdGlvbnMuY2hlY2tzIH0pO1xuICAgIH1cbiAgICBcbiAgICByZXR1cm4gcGFyYW1zO1xuICB9XG59XG4iXX0=